{% extends 'axflo_app/admin/admin_base.html' %}
{% load static %}

{% block title %}Newsletter Management - Axflo Admin{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'axflo_app/css/admin_newsletter.css' %}">
{% endblock %}

{% block content %}
    <div class="newsletter-management-container">
        <!-- Header Section -->
        <div class="newsletter-header">
            <div class="header-content">
                <div class="header-text">
                    <h1><i class="fas fa-envelope-open"></i> Newsletter Management</h1>
                    <p>Create, manage, and send newsletters to your subscribers</p>
                </div>
                <div class="header-actions">
                    <a href="/admin-newsletter-create/" class="btn btn-primary" data-action="create-newsletter">
                        <i class="fas fa-plus"></i> Create Newsletter
                    </a>
                    <a href="/admin-newsletter-categories/" class="btn btn-secondary">
                        <i class="fas fa-tags"></i> Manage Categories
                    </a>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-newspaper"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number">{{ total_newsletters }}</div>
                    <div class="stat-label">Total Newsletters</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-paper-plane"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number">{{ sent_newsletters }}</div>
                    <div class="stat-label">Sent This Month</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number">{{ total_subscribers }}</div>
                    <div class="stat-label">Active Subscribers</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number">{{ avg_open_rate }}%</div>
                    <div class="stat-label">Avg. Open Rate</div>
                </div>
            </div>
        </div>

        <!-- Filters and Search -->
        <div class="filters-section">
            <div class="search-filters">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Search newsletters..." id="searchInput">
                </div>
                
                <div class="filter-group">
                    <select id="statusFilter" class="filter-select">
                        <option value="">All Status</option>
                        <option value="draft">Draft</option>
                        <option value="scheduled">Scheduled</option>
                        <option value="sent">Sent</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <select id="categoryFilter" class="filter-select">
                        <option value="">All Categories</option>
                        {% for category in categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <button class="btn btn-outline" id="clearFilters">
                    <i class="fas fa-times"></i> Clear
                </button>
            </div>
        </div>

        <!-- Newsletter List -->
        <div class="newsletters-section">
            <div class="section-header">
                <h2><i class="fas fa-list"></i> Newsletter List</h2>
                <div class="bulk-actions">
                    <select id="bulkAction" class="filter-select">
                        <option value="">Bulk Actions</option>
                        <option value="delete">Delete Selected</option>
                        <option value="archive">Archive Selected</option>
                    </select>
                    <button class="btn btn-outline" id="applyBulk">Apply</button>
                </div>
            </div>

            <div class="newsletters-grid">
                {% for newsletter in newsletters %}
                    <div class="newsletter-card" data-status="{{ newsletter.status }}" data-category="{{ newsletter.category.id|default:'' }}">
                        <div class="newsletter-header-card">
                            <div class="newsletter-checkbox">
                                <input type="checkbox" class="newsletter-select" value="{{ newsletter.id }}">
                            </div>
                            <div class="newsletter-status status-{{ newsletter.status }}">
                                {{ newsletter.get_status_display }}
                            </div>
                        </div>
                        
                        <div class="newsletter-content">
                            <h3 class="newsletter-title">{{ newsletter.title }}</h3>
                            <div class="newsletter-meta">
                                <div class="meta-item">
                                    <i class="fas fa-calendar"></i>
                                    <span>{{ newsletter.created_date|date:"M d, Y" }}</span>
                                </div>
                                {% if newsletter.send_date %}
                                    <div class="meta-item">
                                        <i class="fas fa-clock"></i>
                                        <span>{{ newsletter.send_date|date:"M d, Y g:i A" }}</span>
                                    </div>
                                {% endif %}
                                {% if newsletter.category %}
                                    <div class="meta-item">
                                        <i class="fas fa-tag"></i>
                                        <span>{{ newsletter.category.name }}</span>
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="newsletter-excerpt">
                                {{ newsletter.content|truncatewords:20|striptags }}
                            </div>
                            
                            <div class="newsletter-stats">
                                <div class="stat-item">
                                    <i class="fas fa-users"></i>
                                    <span>{{ newsletter.recipient_count }} Recipients</span>
                                </div>
                                {% if newsletter.sent %}
                                    <div class="stat-item">
                                        <i class="fas fa-eye"></i>
                                        <span>{{ newsletter.open_rate|default:"0" }}% Opened</span>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="newsletter-actions">
                            {% if not newsletter.sent %}
                                <a href="/admin-newsletter-edit/{{ newsletter.id }}/" class="action-btn btn-edit">
                                    <i class="fas fa-edit"></i> Edit
                                </a>
                            {% else %}
                                <a href="/admin-newsletter-view/{{ newsletter.id }}/" class="action-btn btn-view">
                                    <i class="fas fa-eye"></i> View
                                </a>
                            {% endif %}
                            
                            {% if newsletter.status == 'draft' %}
                                <button class="action-btn btn-send" data-newsletter="{{ newsletter.id }}">
                                    <i class="fas fa-paper-plane"></i> Send
                                </button>
                            {% endif %}
                            
                            <a href="/admin-newsletter-duplicate/{{ newsletter.id }}/" class="action-btn btn-duplicate">
                                <i class="fas fa-copy"></i> Duplicate
                            </a>
                            
                            <button class="action-btn btn-delete" data-newsletter="{{ newsletter.id }}">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                {% empty %}
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-envelope-open"></i>
                        </div>
                        <h3>No Newsletters Found</h3>
                        <p>Create your first newsletter to get started with email marketing.</p>
                        <a href="/admin-newsletters-create/" class="btn btn-primary" data-action="create-newsletter">
                            <i class="fas fa-plus"></i> Create First Newsletter
                        </a>
                    </div>
                {% endfor %}
            </div>

            <!-- Pagination -->
            {% if is_paginated %}
                <div class="pagination-section">
                    <div class="pagination-info">
                        Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} of {{ paginator.count }} newsletters
                    </div>
                    <div class="pagination-controls">
                        {% if page_obj.has_previous %}
                            <a href="?page=1" class="page-btn">First</a>
                            <a href="?page={{ page_obj.previous_page_number }}" class="page-btn">Previous</a>
                        {% endif %}
                        
                        <span class="page-current">
                            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                        </span>
                        
                        {% if page_obj.has_next %}
                            <a href="?page={{ page_obj.next_page_number }}" class="page-btn">Next</a>
                            <a href="?page={{ page_obj.paginator.num_pages }}" class="page-btn">Last</a>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Newsletter Creation Modal -->
    <div id="createNewsletterModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-plus"></i> Create New Newsletter</h3>
                <button class="modal-close">&times;</button>
            </div>
            <form id="createNewsletterForm" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="form-group">
                        <label for="newsletterTitle">Newsletter Title *</label>
                        <input type="text" id="newsletterTitle" name="title" class="form-control" required>
                        <div class="form-help">This will be the subject line of your email</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="newsletterCategory">Category</label>
                        <select id="newsletterCategory" name="category" class="form-control">
                            <option value="">Select Category</option>
                            {% for category in categories %}
                                <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="newsletterTemplate">Template</label>
                        <select id="newsletterTemplate" name="template" class="form-control">
                            <option value="basic">Basic Newsletter</option>
                            <option value="announcement">Company Announcement</option>
                            <option value="project_update">Project Update</option>
                            <option value="safety_alert">Safety Alert</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary modal-cancel">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Newsletter</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Send Newsletter Modal -->
    <div id="sendNewsletterModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-paper-plane"></i> Send Newsletter</h3>
                <button class="modal-close">&times;</button>
            </div>
            <form id="sendNewsletterForm" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="send-confirmation">
                        <div class="confirmation-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <h4>Confirm Newsletter Send</h4>
                        <p>Are you sure you want to send this newsletter? This action cannot be undone.</p>
                        
                        <div class="send-details">
                            <div class="detail-item">
                                <strong>Recipients:</strong> <span id="recipientCount">0</span> subscribers
                            </div>
                            <div class="detail-item">
                                <strong>Estimated Delivery:</strong> <span id="deliveryTime">Immediate</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="sendTestEmail" name="send_test"> 
                            Send test email to myself first
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary modal-cancel">Cancel</button>
                    <button type="submit" class="btn btn-primary btn-send">Send Newsletter</button>
                </div>
            </form>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Search functionality
            const searchInput = document.getElementById('searchInput');
            const statusFilter = document.getElementById('statusFilter');
            const categoryFilter = document.getElementById('categoryFilter');
            const clearFilters = document.getElementById('clearFilters');
            
            // Modal functionality
            const createModal = document.getElementById('createNewsletterModal');
            const sendModal = document.getElementById('sendNewsletterModal');
            const createBtns = document.querySelectorAll('[data-action="create-newsletter"]');
            const sendBtns = document.querySelectorAll('.btn-send');
            
            // Open create modal
            createBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    createModal.style.display = 'flex';
                });
            });
            
            // Open send modal
            sendBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const newsletterId = btn.dataset.newsletter;
                    // Load newsletter details and show modal
                    sendModal.style.display = 'flex';
                });
            });
            
            // Close modals
            document.querySelectorAll('.modal-close, .modal-cancel').forEach(btn => {
                btn.addEventListener('click', () => {
                    createModal.style.display = 'none';
                    sendModal.style.display = 'none';
                });
            });
            
            // Filter functionality
            function filterNewsletters() {
                const searchTerm = searchInput.value.toLowerCase();
                const statusValue = statusFilter.value;
                const categoryValue = categoryFilter.value;
                
                document.querySelectorAll('.newsletter-card').forEach(card => {
                    const title = card.querySelector('.newsletter-title').textContent.toLowerCase();
                    const cardStatus = card.dataset.status;
                    const cardCategory = card.dataset.category;
                    
                    const matchesSearch = title.includes(searchTerm);
                    const matchesStatus = !statusValue || cardStatus === statusValue;
                    const matchesCategory = !categoryValue || cardCategory === categoryValue;
                    
                    card.style.display = matchesSearch && matchesStatus && matchesCategory ? 'block' : 'none';
                });
            }
            
            searchInput.addEventListener('input', filterNewsletters);
            statusFilter.addEventListener('change', filterNewsletters);
            categoryFilter.addEventListener('change', filterNewsletters);
            
            clearFilters.addEventListener('click', () => {
                searchInput.value = '';
                statusFilter.value = '';
                categoryFilter.value = '';
                filterNewsletters();
            });
            
            // Bulk actions
            const bulkAction = document.getElementById('bulkAction');
            const applyBulk = document.getElementById('applyBulk');
            const checkboxes = document.querySelectorAll('.newsletter-select');
            
            applyBulk.addEventListener('click', () => {
                const selectedIds = Array.from(checkboxes)
                    .filter(cb => cb.checked)
                    .map(cb => cb.value);
                
                if (selectedIds.length === 0) {
                    alert('Please select newsletters to perform bulk action.');
                    return;
                }
                
                const action = bulkAction.value;
                if (!action) {
                    alert('Please select an action to perform.');
                    return;
                }
                
                if (confirm(`Are you sure you want to ${action} ${selectedIds.length} newsletter(s)?`)) {
                    // Perform bulk action
                    console.log(`Performing ${action} on newsletters:`, selectedIds);
                }
            });
            
            // Delete functionality
            document.querySelectorAll('.btn-delete').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const newsletterId = btn.dataset.newsletter;
                    const newsletterTitle = btn.closest('.newsletter-card').querySelector('.newsletter-title').textContent;
                    
                    if (confirm(`Are you sure you want to delete the newsletter "${newsletterTitle}"? This action cannot be undone.`)) {
                        // Show loading state
                        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
                        btn.disabled = true;
                        
                        fetch(`/admin-newsletter-delete/${newsletterId}/`, {
                            method: 'POST',
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest',
                                'X-CSRFToken': getCookie('csrftoken')
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Remove newsletter card with animation
                                const card = btn.closest('.newsletter-card');
                                card.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                                card.style.opacity = '0';
                                card.style.transform = 'scale(0.9)';
                                
                                setTimeout(() => {
                                    card.remove();
                                    // Show success message
                                    showNotification(data.message, 'success');
                                }, 300);
                            } else {
                                showNotification(data.message || 'Error deleting newsletter', 'error');
                                // Reset button
                                btn.innerHTML = '<i class="fas fa-trash"></i> Delete';
                                btn.disabled = false;
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            showNotification('Error deleting newsletter', 'error');
                            // Reset button
                            btn.innerHTML = '<i class="fas fa-trash"></i> Delete';
                            btn.disabled = false;
                        });
                    }
                });
            });
            
            // Helper functions
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            
            function showNotification(message, type = 'info') {
                // Create notification element
                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                notification.innerHTML = `
                    <div class="notification-content">
                        <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-triangle' : 'fa-info-circle'}"></i>
                        <span>${message}</span>
                    </div>
                    <button class="notification-close">&times;</button>
                `;
                
                // Style the notification
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: var(--card-bg);
                    border: 1px solid var(--card-border);
                    border-radius: 8px;
                    padding: 15px 20px;
                    box-shadow: var(--shadow-primary);
                    backdrop-filter: blur(var(--blur-amount));
                    z-index: 10000;
                    max-width: 400px;
                    color: var(--text-primary);
                    transform: translateX(100%);
                    transition: transform 0.3s ease;
                `;
                
                // Color based on type
                if (type === 'success') {
                    notification.style.borderColor = '#22c55e';
                } else if (type === 'error') {
                    notification.style.borderColor = '#ef4444';
                }
                
                document.body.appendChild(notification);
                
                // Animate in
                setTimeout(() => {
                    notification.style.transform = 'translateX(0)';
                }, 10);
                
                // Close functionality
                const closeBtn = notification.querySelector('.notification-close');
                closeBtn.addEventListener('click', () => {
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => notification.remove(), 300);
                });
                
                // Auto remove after 5 seconds
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.style.transform = 'translateX(100%)';
                        setTimeout(() => notification.remove(), 300);
                    }
                }, 5000);
            }
        });
    </script>
{% endblock %}