{% extends 'axflo_app/admin/admin_base.html' %}
{% load static %}

{% block title %}Create Newsletter - Axflo Admin{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'axflo_app/css/admin_newsletter_create.css' %}">
    <!-- Rich Text Editor -->
    <script src="https://cdn.ckeditor.com/ckeditor5/35.3.0/classic/ckeditor.js"></script>
{% endblock %}

{% block content %}
    <div class="newsletter-create-container">
        <!-- Header Section -->
        <div class="create-header">
            <div class="header-content">
                <div class="header-text">
                    <h1><i class="fas fa-plus"></i> Create New Newsletter</h1>
                    <p>Design and send newsletters to your subscribers</p>
                </div>
                <div class="header-actions">
                    <a href="/admin-newsletters/" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Newsletters
                    </a>
                    <button type="button" class="btn btn-outline" id="previewBtn">
                        <i class="fas fa-eye"></i> Preview
                    </button>
                </div>
            </div>
        </div>

        <!-- Newsletter Creation Form -->
        <form method="post" id="newsletterForm" class="newsletter-form">
            {% csrf_token %}
            
            <!-- Display form-wide errors -->
            {% if form.non_field_errors %}
                <div class="alert alert-danger">
                    {% for error in form.non_field_errors %}
                        <div class="error">{{ error }}</div>
                    {% endfor %}
                </div>
            {% endif %}
            
            <div class="form-layout">
                <!-- Left Column - Main Content -->
                <div class="main-content">
                    <!-- Basic Information Section -->
                    <div class="form-section">
                        <div class="section-header">
                            <h2><i class="fas fa-info-circle"></i> Basic Information</h2>
                            <p>Set up the basic details of your newsletter</p>
                        </div>
                        
                        <div class="form-group">
                            <label for="{{ form.title.id_for_label }}" class="form-label">Newsletter Title *</label>
                            {{ form.title }}
                            {% if form.title.help_text %}
                                <div class="form-help">{{ form.title.help_text }}</div>
                            {% endif %}
                            {% if form.title.errors %}
                                <div class="form-errors">
                                    {% for error in form.title.errors %}
                                        <div class="error">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="form-group">
                            <label for="{{ form.template_type.id_for_label }}" class="form-label">Newsletter Template</label>
                            {{ form.template_type }}
                            {% if form.template_type.help_text %}
                                <div class="form-help">{{ form.template_type.help_text }}</div>
                            {% endif %}
                            {% if form.template_type.errors %}
                                <div class="form-errors">
                                    {% for error in form.template_type.errors %}
                                        <div class="error">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Content Section -->
                    <div class="form-section">
                        <div class="section-header">
                            <h2><i class="fas fa-edit"></i> Newsletter Content</h2>
                            <p>Create your newsletter content with rich text formatting</p>
                        </div>
                        
                        <div class="form-group">
                            <label for="{{ form.content.id_for_label }}" class="form-label">Content *</label>
                            {{ form.content }}
                            {% if form.content.help_text %}
                                <div class="form-help">{{ form.content.help_text }}</div>
                            {% endif %}
                            {% if form.content.errors %}
                                <div class="form-errors">
                                    {% for error in form.content.errors %}
                                        <div class="error">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <!-- Content Templates -->
                        <div class="content-templates">
                            <h3>Content Templates</h3>
                            <div class="template-grid">
                                <div class="template-card" data-template="company-news">
                                    <div class="template-icon">
                                        <i class="fas fa-building"></i>
                                    </div>
                                    <h4>Company News</h4>
                                    <p>Updates and announcements</p>
                                    <button type="button" class="btn btn-outline btn-sm load-template">Use Template</button>
                                </div>
                                
                                <div class="template-card" data-template="project-update">
                                    <div class="template-icon">
                                        <i class="fas fa-project-diagram"></i>
                                    </div>
                                    <h4>Project Update</h4>
                                    <p>Progress reports and milestones</p>
                                    <button type="button" class="btn btn-outline btn-sm load-template">Use Template</button>
                                </div>
                                
                                <div class="template-card" data-template="safety-alert">
                                    <div class="template-icon">
                                        <i class="fas fa-shield-alt"></i>
                                    </div>
                                    <h4>Safety Alert</h4>
                                    <p>Important safety information</p>
                                    <button type="button" class="btn btn-outline btn-sm load-template">Use Template</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column - Settings -->
                <div class="sidebar-content">
                    <!-- Recipients Section -->
                    <div class="form-section">
                        <div class="section-header">
                            <h3><i class="fas fa-users"></i> Recipients</h3>
                            <p>Choose who will receive this newsletter</p>
                        </div>
                        
                        <div class="recipients-info">
                            <div class="recipient-count">
                                <span class="count-number" id="recipientCount">0</span>
                                <span class="count-label">Subscribers</span>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Target Categories</label>
                            <div class="categories-list" id="categories-container">
                                {% for option in form.categories %}
                                    <label class="category-checkbox">
                                        {{ option.tag }}
                                        <span class="checkbox-custom"></span>
                                        <span class="category-info">
                                            <span class="category-name">{{ option.choice_label }}</span>
                                            <span class="category-count">{{ option.data.subscriber_count|default:0 }} subscribers</span>
                                        </span>
                                    </label>
                                {% empty %}
                                    <div class="no-categories">
                                        <p>No categories available.</p>
                                        <a href="/admin-newsletter-categories/" class="btn btn-outline btn-sm">
                                            <i class="fas fa-plus"></i> Create Categories
                                        </a>
                                    </div>
                                {% endfor %}
                            </div>
                            {% if form.categories.help_text %}
                                <div class="form-help">{{ form.categories.help_text }}</div>
                            {% endif %}
                            {% if form.categories.errors %}
                                <div class="form-errors">
                                    {% for error in form.categories.errors %}
                                        <div class="error">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Sending Options -->
                    <div class="form-section">
                        <div class="section-header">
                            <h3><i class="fas fa-paper-plane"></i> Sending Options</h3>
                            <p>Choose when to send your newsletter</p>
                        </div>
                        
                        <div class="sending-options">
                            {% for choice in form.send_option %}
                                <label class="option-radio">
                                    {{ choice.tag }}
                                    <span class="radio-custom"></span>
                                    <span class="option-info">
                                        {% if choice.choice_value == 'draft' %}
                                            <span class="option-title">Save as Draft</span>
                                            <span class="option-desc">Save without sending, review later</span>
                                        {% elif choice.choice_value == 'immediate' %}
                                            <span class="option-title">Send Immediately</span>
                                            <span class="option-desc">Send to all selected subscribers now</span>
                                        {% elif choice.choice_value == 'scheduled' %}
                                            <span class="option-title">Schedule for Later</span>
                                            <span class="option-desc">Set a specific date and time</span>
                                        {% endif %}
                                    </span>
                                </label>
                            {% endfor %}
                        </div>
                        
                        {% if form.send_option.help_text %}
                            <div class="form-help">{{ form.send_option.help_text }}</div>
                        {% endif %}
                        {% if form.send_option.errors %}
                            <div class="form-errors">
                                {% for error in form.send_option.errors %}
                                    <div class="error">{{ error }}</div>
                                {% endfor %}
                            </div>
                        {% endif %}
                        
                        <div class="schedule-options" id="scheduleOptions" style="display: none;">
                            <div class="form-group">
                                <label for="{{ form.send_date.id_for_label }}" class="form-label">Send Date</label>
                                {{ form.send_date }}
                                {% if form.send_date.errors %}
                                    <div class="form-errors">
                                        {% for error in form.send_date.errors %}
                                            <div class="error">{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="form-group">
                                <label for="{{ form.send_time.id_for_label }}" class="form-label">Send Time</label>
                                {{ form.send_time }}
                                {% if form.send_time.errors %}
                                    <div class="form-errors">
                                        {% for error in form.send_time.errors %}
                                            <div class="error">{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Additional Options -->
                    <div class="form-section">
                        <div class="section-header">
                            <h3><i class="fas fa-cog"></i> Additional Options</h3>
                        </div>
                        
                        <div class="form-group">
                            <label class="checkbox-option">
                                {{ form.send_test }}
                                <span class="checkbox-custom"></span>
                                <span>Send test email to myself first</span>
                            </label>
                            {% if form.send_test.errors %}
                                <div class="form-errors">
                                    {% for error in form.send_test.errors %}
                                        <div class="error">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="form-group">
                            <label class="checkbox-option">
                                {{ form.track_opens }}
                                <span class="checkbox-custom"></span>
                                <span>Track email opens</span>
                            </label>
                            {% if form.track_opens.errors %}
                                <div class="form-errors">
                                    {% for error in form.track_opens.errors %}
                                        <div class="error">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="form-group">
                            <label class="checkbox-option">
                                {{ form.track_clicks }}
                                <span class="checkbox-custom"></span>
                                <span>Track link clicks</span>
                            </label>
                            {% if form.track_clicks.errors %}
                                <div class="form-errors">
                                    {% for error in form.track_clicks.errors %}
                                        <div class="error">{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                       <div class="form-actions">
                <div class="action-group">
                    <button type="button" class="btn btn-secondary" id="saveDraftBtn">
                        <i class="fas fa-save"></i> Save as Draft
                    </button>
                    <button type="submit" class="btn btn-primary" id="createNewsletterBtn">
                        <i class="fas fa-plus"></i> Create Newsletter
                    </button>
                </div>
                
                <div class="action-info">
                    <p>Your newsletter will be created based on the sending option selected above.</p>
                </div>
            </div>
            </div>

            <!-- Form Actions -->
     
        </form>
    </div>

    <!-- Preview Modal -->
    <div id="previewModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3><i class="fas fa-eye"></i> Newsletter Preview</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="preview-container">
                    <div class="email-preview">
                        <div class="email-header">
                            <div class="email-subject" id="previewSubject">Newsletter Subject</div>
                            <div class="email-from">From: Axflo Oil & Gas</div>
                        </div>
                        <div class="email-content" id="previewContent">
                            Newsletter content will appear here...
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary modal-cancel">Close Preview</button>
                <button type="button" class="btn btn-primary" id="previewSendBtn">Looks Good - Create Newsletter</button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Rich text editor initialization
            let editor;
            const contentField = document.querySelector('#id_content');
            if (contentField) {
                ClassicEditor
                    .create(contentField, {
                    toolbar: [
                        'heading', '|',
                        'bold', 'italic', 'link', '|',
                        'bulletedList', 'numberedList', '|',
                        'outdent', 'indent', '|',
                        'blockQuote', 'insertTable', '|',
                        'undo', 'redo'
                    ],
                    heading: {
                        options: [
                            { model: 'paragraph', title: 'Paragraph', class: 'ck-heading_paragraph' },
                            { model: 'heading1', view: 'h1', title: 'Heading 1', class: 'ck-heading_heading1' },
                            { model: 'heading2', view: 'h2', title: 'Heading 2', class: 'ck-heading_heading2' },
                            { model: 'heading3', view: 'h3', title: 'Heading 3', class: 'ck-heading_heading3' }
                        ]
                    }
                    })
                    .then(newEditor => {
                        editor = newEditor;
                    })
                    .catch(error => {
                        console.error(error);
                    });
            }

            // Elements
            const categoryCheckboxes = document.querySelectorAll('input[name="categories"]');
            const recipientCount = document.getElementById('recipientCount');
            const sendOptions = document.querySelectorAll('input[name="send_option"]');
            const scheduleOptions = document.getElementById('scheduleOptions');
            const previewBtn = document.getElementById('previewBtn');
            const previewModal = document.getElementById('previewModal');
            const saveDraftBtn = document.getElementById('saveDraftBtn');
            const createNewsletterBtn = document.getElementById('createNewsletterBtn');
            const newsletterForm = document.getElementById('newsletterForm');

            // Template content
            const templates = {
                'company-news': `
                    <h1>Company News Update</h1>
                    <p>Dear Valued Subscribers,</p>
                    <p>We're excited to share the latest updates from Axflo Oil & Gas...</p>
                    <h2>What's New</h2>
                    <ul>
                        <li>Recent achievements and milestones</li>
                        <li>New project announcements</li>
                        <li>Team updates and recognitions</li>
                    </ul>
                    <p>Best regards,<br>The Axflo Team</p>
                `,
                'project-update': `
                    <h1>Project Progress Update</h1>
                    <p>Dear Stakeholders,</p>
                    <p>Here's the latest progress report on our ongoing projects...</p>
                    <h2>Current Projects</h2>
                    <h3>Project Alpha - North Sea Installation</h3>
                    <p>Status: On track<br>Completion: 85%<br>Next milestone: Equipment testing</p>
                    <h3>Project Beta - Pipeline Maintenance</h3>
                    <p>Status: Ahead of schedule<br>Completion: 92%<br>Expected finish: Next month</p>
                    <p>For more details, please contact our project management team.</p>
                `,
                'safety-alert': `
                    <h1>⚠️ Important Safety Alert</h1>
                    <p><strong>ATTENTION ALL PERSONNEL</strong></p>
                    <p>This is an important safety notification regarding...</p>
                    <h2>Immediate Actions Required</h2>
                    <ol>
                        <li>Review updated safety protocols</li>
                        <li>Attend mandatory safety briefing</li>
                        <li>Update emergency contact information</li>
                    </ol>
                    <p><strong>Compliance deadline:</strong> [Insert date]</p>
                    <p>For questions, contact the Safety Department immediately.</p>
                `
            };

            // Update recipient count
            function updateRecipientCount() {
                let totalRecipients = 0;
                categoryCheckboxes.forEach(checkbox => {
                    if (checkbox.checked) {
                        totalRecipients += parseInt(checkbox.dataset.subscribers) || 0;
                    }
                });
                recipientCount.textContent = totalRecipients;
            }

            // Category checkbox change handler
            categoryCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', updateRecipientCount);
            });

            // Send option change handler
            sendOptions.forEach(option => {
                option.addEventListener('change', function() {
                    if (this.value === 'scheduled') {
                        scheduleOptions.style.display = 'block';
                    } else {
                        scheduleOptions.style.display = 'none';
                    }
                });
            });

            // Template loading
            document.querySelectorAll('.load-template').forEach(btn => {
                btn.addEventListener('click', function() {
                    const templateType = this.closest('.template-card').dataset.template;
                    if (templates[templateType] && editor) {
                        editor.setData(templates[templateType]);
                        // Scroll to editor
                        document.querySelector('.rich-editor').scrollIntoView({
                            behavior: 'smooth',
                            block: 'center'
                        });
                    }
                });
            });

            // Preview functionality
            previewBtn.addEventListener('click', function() {
                const titleField = document.getElementById('id_title');
                const contentField = document.getElementById('id_content');
                
                const title = titleField ? titleField.value : '';
                const content = editor ? editor.getData() : (contentField ? contentField.value : '');
                
                document.getElementById('previewSubject').textContent = title || 'Newsletter Subject';
                document.getElementById('previewContent').innerHTML = content || 'Newsletter content will appear here...';
                
                previewModal.style.display = 'flex';
            });

            // Modal close
            document.querySelectorAll('.modal-close, .modal-cancel').forEach(btn => {
                btn.addEventListener('click', () => {
                    previewModal.style.display = 'none';
                });
            });

            // Save as draft
            saveDraftBtn.addEventListener('click', function() {
                document.querySelector('input[name="send_option"][value="draft"]').checked = true;
                newsletterForm.submit();
            });

            // Form submission
            newsletterForm.addEventListener('submit', function(e) {
                // Update content from editor
                const contentField = document.getElementById('id_content');
                if (editor && contentField) {
                    contentField.value = editor.getData();
                }

                // Set immediate sending flag
                const sendOption = document.querySelector('input[name="send_option"]:checked').value;
                if (sendOption === 'immediate') {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'send_immediately';
                    input.value = 'on';
                    this.appendChild(input);
                }

                // Validate required fields - Django forms will handle this
                const titleField = document.getElementById('id_title');
                const contentField = document.getElementById('id_content');
                
                if (titleField && !titleField.value.trim()) {
                    e.preventDefault();
                    alert('Please enter a newsletter title.');
                    titleField.focus();
                    return;
                }

                if (contentField && !contentField.value.trim()) {
                    e.preventDefault();
                    alert('Please enter newsletter content.');
                    return;
                }

                // Confirm sending if immediate
                if (sendOption === 'immediate') {
                    const recipientCount = document.getElementById('recipientCount').textContent;
                    if (!confirm(`Are you sure you want to send this newsletter immediately to ${recipientCount} subscribers?`)) {
                        e.preventDefault();
                        return;
                    }
                }
            });

            // Initialize recipient count
            updateRecipientCount();
        });
    </script>
{% endblock %}